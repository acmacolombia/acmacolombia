---
import Layout from '~/layouts/PageLayout.astro';
import { getLangFromUrl, useTranslations } from '~/i18n/utils';
import BlogLatestPosts from '~/components/widgets/BlogLatestPosts.astro';
const locale = getLangFromUrl(Astro.url);
const t = useTranslations(locale);

const metadata = {
  title: t('nav.events'),
};

const postsImport = import.meta.glob('/src/content/post/**/*.md*', { eager: true });
const allPosts = Object.values(postsImport).map((m: any) => ({
  ...((m as any).frontmatter ?? {}),
  url: (m as any).url ?? (m as any).file ?? undefined,
}));

const categoryLabel = locale?.startsWith('es') ? 'eventos' : 'events';

function matchesCategory(post: any) {
  if (!post) return false;
  const cat = post.category ?? post.categories ?? [];
  if (Array.isArray(cat)) return cat.map(c => String(c).toLowerCase()).includes(categoryLabel);
  return String(cat).toLowerCase() === categoryLabel;
}

const eventPosts = allPosts
  .filter(matchesCategory)
  .sort((a, b) => {
    const da = new Date(a.date ?? a.published ?? 0).getTime();
    const db = new Date(b.date ?? b.published ?? 0).getTime();
    return db - da;
  });
---

<Layout metadata={metadata}>
  <section style="max-width:1200px;margin:0 auto;padding:1rem;">
    <title>{t('nav.events')}</title>
      <h1 style="margin-bottom:0.5rem;"></h1>
      <p style="font-size:1.1rem;color:var(--color-muted);">Consulta aquí nuestro calendario actualizado de eventos, talleres, charlas y más.</p>
    <!-- Luma Calendar -->
      <iframe 
        src="https://luma.com/embed/calendar/cal-Rm6fnGe9eB88fab/events" 
        width="100%" 
        height="800" 
        style="border: none; overflow: hidden; border-radius:6px;" 
        frameborder="0" 
        allowfullscreen>
      </iframe>
      <p style="margin-top: 1em;text-align:center;">
        <a href="https://luma.com/acmacolombia?k=c" target="_blank" rel="noopener noreferrer">
          Si no puedes ver el calendario, haz clic aquí.
        </a>
      </p>

      
  <!-- HighlightedPosts Widget ******* -->
  <BlogLatestPosts
    title="Artículos"
    information={`                `}
  />


    <!-- Publications Section -->
    <div style="max-width:900px;margin:0 auto;text-align:center;">
      <h2 style="margin-bottom:2rem;">{locale.startsWith('es') ? 'Publicaciones' : 'Publications'}</h2>
      
      {eventPosts.length === 0 ? (
        <p>{ locale.startsWith('es') ? 'No hay publicaciones de eventos.' : 'No event posts found.' }</p>
      ) : (
        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:1.5rem;text-align:left;">
          {eventPosts.map(post => (
            <article style="background:#fff;border:1px solid #e6e6e6;border-radius:6px;padding:1.5rem;transition:box-shadow 0.3s;">
              <h3 style="margin-top:0;margin-bottom:0.5rem;">
                <a href={post.url ?? '#'} style="text-decoration:none;color:var(--color-text);">
                  {post.title ?? post.headline ?? 'Untitled'}
                </a>
              </h3>
              <div style="font-size:0.85rem;color:var(--color-muted);margin-bottom:0.75rem;">
                {post.date ? new Date(post.date).toLocaleDateString(locale) : ''}
              </div>
              {post.excerpt && (
                <p style="font-size:0.95rem;color:var(--color-muted);margin:0.75rem 0;">
                  {post.excerpt}
                </p>
              )}
              <a href={post.url ?? '#'} style="color:var(--color-primary);text-decoration:none;font-weight:500;">
                {locale.startsWith('es') ? 'Leer más' : 'Read more'} →
              </a>
            </article>
          ))}
        </div>
      )}
    </div>
  </section>
</Layout>