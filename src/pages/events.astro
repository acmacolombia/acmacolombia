---
import Layout from '~/layouts/PageLayout.astro';
import { getLangFromUrl, useTranslations } from '~/i18n/utils';
const locale = getLangFromUrl(Astro.url);
const t = useTranslations(locale);

const metadata = {
  title: t('nav.events'),
};

const postsImport = import.meta.glob('/src/content/posts/**/*.md*', { eager: true });
const allPosts = Object.values(postsImport).map((m: any) => ({
  ...((m as any).frontmatter ?? {}),
  url: (m as any).url ?? (m as any).file ?? undefined,
}));

const categoryLabel = locale?.startsWith('es') ? 'eventos' : 'events';

function matchesCategory(post: any) {
  if (!post) return false;
  const cat = post.category ?? post.categories ?? [];
  if (Array.isArray(cat)) return cat.map(c => String(c).toLowerCase()).includes(categoryLabel);
  return String(cat).toLowerCase() === categoryLabel;
}

const eventPosts = allPosts
  .filter(matchesCategory)
  .sort((a, b) => {
    const da = new Date(a.date ?? a.published ?? 0).getTime();
    const db = new Date(b.date ?? b.published ?? 0).getTime();
    return db - da;
  });
---

<Layout metadata={metadata}>
  <section style="max-width:1200px;margin:0 auto;padding:1rem;">
    <h1 style="text-align:center;">{t('nav.events')}</h1>
    <p style="text-align:center;">Consulta aquí nuestro calendario actualizado de eventos, talleres, charlas y más.</p>

    <div style="display:grid;grid-template-columns: 1fr 360px; gap:1rem; align-items:start;">
      <div style="min-width:0;">
        <iframe 
          src="https://luma.com/embed/calendar/cal-Rm6fnGe9eB88fab/events" 
          width="100%" 
          height="800" 
          style="border: none; overflow: hidden; border-radius:6px;" 
          frameborder="0" 
          allowfullscreen>
        </iframe>
        <p style="margin-top: 1em;">
          <a href="https://luma.com/acmacolombia?k=c" target="_blank" rel="noopener noreferrer">
            Si no puedes ver el calendario, haz clic aquí.
          </a>
        </p>
      </div>

      <aside style="background:#fff;border:1px solid #e6e6e6;padding:1rem;border-radius:6px;">
        <h2 style="margin-top:0;">{t('nav.events')} — {locale.startsWith('es') ? 'Publicaciones' : 'Posts'}</h2>
        {eventPosts.length === 0 ? (
          <p>{ locale.startsWith('es') ? 'No hay publicaciones de eventos.' : 'No event posts found.' }</p>
        ) : (
          <ul style="list-style:none;padding:0;margin:0;">
            {eventPosts.map(post => (
              <li style="margin-bottom:0.75rem;">
                <a href={post.url ?? '#'} style="text-decoration:none;color:var(--color-text);">
                  <strong>{post.title ?? post.headline ?? 'Untitled'}</strong>
                </a>
                <div style="font-size:0.85rem;color:var(--color-muted);">
                  {post.date ? new Date(post.date).toLocaleDateString(locale) : ''}
                </div>
              </li>
            ))}
          </ul>
        )}
      </aside>
    </div>
  </section>
</Layout>